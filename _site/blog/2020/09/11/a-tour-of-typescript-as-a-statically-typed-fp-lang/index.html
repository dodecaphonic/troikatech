<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>A Tour of TypeScript as a Typed Functional Programming Language | Troika Tech</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="A Tour of TypeScript as a Typed Functional Programming Language" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="If you’ve been curious about (or studying) statically typed functional programming for a while, I bet you’ve asked yourself these questions:" />
<meta property="og:description" content="If you’ve been curious about (or studying) statically typed functional programming for a while, I bet you’ve asked yourself these questions:" />
<link rel="canonical" href="http://localhost:4000/blog/2020/09/11/a-tour-of-typescript-as-a-statically-typed-fp-lang/" />
<meta property="og:url" content="http://localhost:4000/blog/2020/09/11/a-tour-of-typescript-as-a-statically-typed-fp-lang/" />
<meta property="og:site_name" content="Troika Tech" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-09-11T16:25:00-03:00" />
<script type="application/ld+json">
{"headline":"A Tour of TypeScript as a Typed Functional Programming Language","dateModified":"2020-09-11T16:25:00-03:00","datePublished":"2020-09-11T16:25:00-03:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/2020/09/11/a-tour-of-typescript-as-a-statically-typed-fp-lang/"},"url":"http://localhost:4000/blog/2020/09/11/a-tour-of-typescript-as-a-statically-typed-fp-lang/","description":"If you’ve been curious about (or studying) statically typed functional programming for a while, I bet you’ve asked yourself these questions:","@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Troika Tech" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Troika Tech</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">A Tour of TypeScript as a Typed Functional Programming Language</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-09-11T16:25:00-03:00" itemprop="datePublished">Sep 11, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>If you’ve been curious about (or studying) statically typed functional programming for a while, I bet you’ve asked yourself these questions:</p>

<ul>
  <li>How much do I have to learn to apply it successfully?</li>
  <li>Will I ever stop being surprised by how much I don’t know?</li>
  <li>Can I get paid to write code in that style?</li>
</ul>

<p>Digging deeper and becoming more knowledgeable is a fun effort by itself. The third question is more delicate, nuanced, and probably anxiety-inducing than the first two: Haskell (or Haskell-adjacent) jobs are scarce, and your best bet is trying to land a Scala job in an FP-friendly organization.</p>

<p>But there’s a dearth of Scala jobs, as well, and most of them are in the land of data science. There’s no need to grow despondent, though: the easiest to marry statically-typed functional programming and your source of income is to go extremely mainstream and use TypeScript.</p>

<h2 id="does-typescript-pass-muster">Does TypeScript pass muster?</h2>

<p>Yes! You don’t even have to squint that hard.</p>

<p>TypeScript gives you enough tools to make illegal states unrepresentable at compile time, and its type system, by virtue of having to model JavaScript with its every wart, is very interesting and powerful. A few of its features are paramount to typed functional programming:</p>

<ul>
  <li>It has first-class functions;</li>
  <li>It <a href="https://www.typescriptlang.org/docs/handbook/generics.html">supports parametric polymorphism</a>, with rich constructs such as conditional types;</li>
  <li>It can <a href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#type-guards-and-differentiating-types">narrow types using predicates on wider types</a>;</li>
  <li>It allows you to define your data model as Algebraic Data Types.</li>
</ul>

<p>Expressing these concepts might not be as succint as in Haskell, PureScript or Elm, but it’s possible with tolerable noise, with the same compounding benefits you would find in friendlier environs.</p>

<p>What follows is an overview of the basics of using TypeScript successfully as a statically-typed functional programming language. Some of the examples will rely on the <a href="https://gcanti.github.io/fp-ts/">fp-ts</a> ecosystem.</p>

<h2 id="thinking-in-transformations">Thinking in transformations</h2>

<p>One major way FP-style has infected the mainstream is in computations that are built as chainable expressions. In JavaScript, for instance, it would be quite natural to write something like the code below:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">animals</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"giraffe"</span><span class="p">,</span> <span class="na">class</span><span class="p">:</span> <span class="s2">"mammal"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"elephant"</span><span class="p">,</span> <span class="na">class</span><span class="p">:</span> <span class="s2">"mammal"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"crocodile"</span><span class="p">,</span> <span class="na">class</span><span class="p">:</span> <span class="s2">"reptile"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"emu"</span><span class="p">,</span> <span class="na">class</span><span class="p">:</span> <span class="s2">"bird"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"gecko"</span><span class="p">,</span> <span class="na">class</span><span class="p">:</span> <span class="s2">"reptile"</span> <span class="p">}</span>
<span class="p">];</span>

<span class="kd">const</span> <span class="nx">reptilesWithG</span> <span class="o">=</span> <span class="nx">animals</span>
  <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">a</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="kd">class</span> <span class="o">===</span> <span class="s2">"reptile"</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">a</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">name</span> <span class="o">=&gt;</span> <span class="nx">name</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">"g"</span><span class="p">));</span>
</code></pre></div></div>

<p>It has a lot of what’s good about functional programming. Data pipelines, higher-order functions, composability. But why is that way of solving problems interesting?</p>

<p>One way to view it is that it focuses on the <em>what</em> instead of on the <em>how</em>. It doesn’t introduce bindings at the same level as the code you’re interested in — you don’t care about the intermediate steps between <code class="highlighter-rouge">animals</code> and <code class="highlighter-rouge">reptilesWithG</code>. You only care about narrowing the list of animals to the ones you desire.</p>

<p>That immediately brings you a big benefit: a single expression can be refactored easily. It would be easy to fuse the two filters. It would be equally easy to extract a function taking <code class="highlighter-rouge">animals</code> and call it in place. It would be easy to completely change the algorithm.</p>

<p>Data transformation pipelines rely on <em>composability</em>. By building simple functions that rely solely on their inputs and putting them together, you get rich behavior. Each part is understandable if inspected — but they might never have to be inspected, because the behavior they produce is consistent and evident.</p>

<p>Types only enhance these characteristics. Each function will be mechanically verified by the compiler, as will pipelines built with them. If you make a mistake, you’ll get a squiggly line telling you where to fix it.</p>

<p>There are different functional programming libraries for TypeScript, and each implements its pipelining functions. If you use fp-ts, <code class="highlighter-rouge">pipe</code> (and <code class="highlighter-rouge">flow</code>) will be your bread and butter:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">import</span> <span class="p">{</span> <span class="nx">pipe</span> <span class="p">}</span> <span class="k">from</span> <span class="s2">"fp-ts/lib/pipeable"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">A</span> <span class="k">from</span> <span class="s2">"fp-ts/lib/Array"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">reptilesWithG</span> <span class="o">=</span> <span class="nx">pipe</span><span class="p">(</span>
  <span class="nx">animals</span><span class="p">,</span>
  <span class="nx">A</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">a</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="kd">class</span> <span class="o">===</span> <span class="s2">"reptile"</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">startWith</span><span class="p">(</span><span class="s2">"g"</span><span class="p">)),</span>
  <span class="nx">A</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">a</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">pipe</code> passes the results of one step as an argument to the next step. <code class="highlighter-rouge">animals</code> will be the input for <code class="highlighter-rouge">A.filter</code>, and the result of said filtering will be the input for <code class="highlighter-rouge">A.map</code>.</p>

<p>This way of writing the code detaches the Array transformation functions from functions in the <code class="highlighter-rouge">animals</code> object. This is good: not only it makes steps recombinable, it also helps cement the idea that sequences of transformations are not restricted to things in collections. fp-ts makes it easy to do the same thing with asynchronous computations, for instance:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">T</span> <span class="k">from</span> <span class="s2">"fp-ts/lib/Task"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">addPopulation</span> <span class="o">=</span> <span class="p">(</span><span class="nx">animal</span><span class="p">:</span> <span class="nx">Animal</span><span class="p">):</span> <span class="nx">Task</span><span class="o">&lt;</span><span class="nx">AnimalWithPopulation</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">fetchPopulation</span><span class="p">(</span><span class="nx">animal</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span>
    <span class="nx">T</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">population</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="p">...</span><span class="nx">animal</span><span class="p">,</span> <span class="nx">population</span> <span class="p">})</span>
<span class="p">);</span>
</code></pre></div></div>

<p>It also will aid in building your intuitions for the similarities between different structures and computational contexts. <code class="highlighter-rouge">A.map</code> and <code class="highlighter-rouge">T.map</code> are possible because <code class="highlighter-rouge">Array</code> and <code class="highlighter-rouge">Task</code> are both <code class="highlighter-rouge">Functors</code>, for instance, but you don’t even need to know that for them to be useful &amp;emdash; learning that changing data in <code class="highlighter-rouge">Task</code> requires <code class="highlighter-rouge">map</code> and changing data in <code class="highlighter-rouge">Array</code> also requires <code class="highlighter-rouge">map</code> will possibly help in in intuiting that <code class="highlighter-rouge">Either</code> might also require <code class="highlighter-rouge">map</code>.</p>

<h2 id="immutability">Immutability</h2>

<p>JavaScript is not immutable by default. A few tools exist (<code class="highlighter-rouge">Object.freeze</code>, non-writable properties) to avoid mutation at runtime, but they are usually shallow, and require discipline when dealing with data (e.g. you can’t forget a call to <code class="highlighter-rouge">freeze</code>).</p>

<p>TypeScript gives you a few tools to avoid the temptation of changing data in place. You can, for instance, declare interface fields as <code class="highlighter-rouge">readonly</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Animal</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">animal</span> <span class="o">=</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"Tiger"</span> <span class="p">};</span>

<span class="nx">animal</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">"Liger"</span><span class="p">;</span> <span class="c1">// error TS2540: Cannot assign to 'name' because it is a read-only property.</span>
</code></pre></div></div>

<p>As well as declaring Arrays as <code class="highlighter-rouge">readonly</code> (or <code class="highlighter-rouge">ReadonlyArray&lt;T&gt;</code>):</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">answers</span><span class="p">:</span> <span class="nx">readonly</span> <span class="nx">string</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"bar"</span><span class="p">,</span> <span class="s2">"baz"</span><span class="p">];</span>
<span class="nx">answers</span><span class="p">[</span><span class="mi">42</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"what is the question?"</span><span class="p">;</span> <span class="c1">// error TS2542: Index signature in type 'readonly string[]' only permits reading.</span>
</code></pre></div></div>

<p>And function parameters as <code class="highlighter-rouge">Readonly</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Room</span> <span class="p">{</span>
  <span class="nl">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>      <span class="c1">// not readonly</span>
  <span class="nl">occupancy</span><span class="p">:</span> <span class="nx">number</span><span class="p">;</span> <span class="c1">// not readonly</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">changeOccupancy</span><span class="p">(</span><span class="nx">room</span><span class="p">:</span> <span class="nx">Readonly</span><span class="o">&lt;</span><span class="nx">Room</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">Room</span> <span class="p">{</span> 
  <span class="nx">room</span><span class="p">.</span><span class="nx">occupancy</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span> <span class="c1">// error TS2540: Cannot assign to 'occupancy' because it is a read-only property.</span>
  
  <span class="k">return</span> <span class="nx">room</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can even <a href="https://www.sitepoint.com/compile-time-immutability-in-typescript/">make a type recursively immutable</a>.</p>

<h2 id="type-system-features">Type system features</h2>

<p>TypeScript has a structural type system, instead of a nominal one. If you have an <code class="highlighter-rouge">interface Friend { name: string; age: 42; }</code> and a <code class="highlighter-rouge">function isAdult(subject: { age: number }): boolean</code>, passing a <code class="highlighter-rouge">Friend</code> to <code class="highlighter-rouge">isAdult</code> will work, because it requires <code class="highlighter-rouge">age: number</code> and <code class="highlighter-rouge">Friend</code> has an <code class="highlighter-rouge">age: number</code>.</p>

<p>This provides interesting modelling tools and capabilities. Previously I’ve presented <code class="highlighter-rouge">addPopulation</code>, a function that resulted in an asynchronous computation containing <code class="highlighter-rouge">AnimalWithPopulation</code>. Here’s one way you can define that type in TypeScript:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">AnimalWithPopulation</span> <span class="kd">extends</span> <span class="nx">Animal</span> <span class="p">{</span>
  <span class="nl">population</span><span class="p">:</span> <span class="nx">number</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And here’s another:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">type</span> <span class="nx">AnimalWithPopulation</span> <span class="o">=</span> <span class="nx">Animal</span> <span class="o">&amp;</span> <span class="p">{</span>
  <span class="na">population</span><span class="p">:</span> <span class="nx">number</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>It looks like a case of “six of one, half a dozen of the other”, but isn’t. What the second form gives you is a way to <a href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#intersection-types">augment types</a> (TypeScript calls them <em>intersection types</em>) without creating class hierarchies. Say you have an e-commerce site that has some functionality only available for registered customers. A registered customer must have an email and an address, and the presence of an email and the presence of an address are concepts already defined in other places. You could define it as so:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">type</span> <span class="nx">Customer</span> <span class="o">=</span> <span class="p">{</span> <span class="na">lastViewedPage</span><span class="p">:</span> <span class="nx">string</span> <span class="p">};</span>
<span class="nx">type</span> <span class="nx">HasEmail</span> <span class="o">=</span> <span class="p">{</span> <span class="na">email</span><span class="p">:</span> <span class="nx">string</span> <span class="p">};</span>
<span class="nx">type</span> <span class="nx">HasAddress</span> <span class="o">=</span> <span class="p">{</span> <span class="na">address</span><span class="p">:</span> <span class="nx">Address</span> <span class="p">};</span>
<span class="nx">type</span> <span class="nx">HasName</span> <span class="o">=</span> <span class="p">{</span> <span class="na">firstName</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="nx">string</span> <span class="p">};</span>
<span class="nx">type</span> <span class="nx">RegisteredCustomer</span> <span class="o">=</span> <span class="nx">Customer</span> <span class="o">&amp;</span> <span class="nx">HasName</span> <span class="o">&amp;</span> <span class="nx">HasEmail</span> <span class="o">&amp;</span> <span class="nx">HasAddress</span><span class="p">;</span>
</code></pre></div></div>

<p>Admittedly this is a contrived example, but I hope it illustrates an interesting possibility: you can build your domain model in such a way that the code acts only on the pieces it cares about:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">generateLabel</span><span class="p">(</span><span class="nx">recipient</span><span class="p">:</span> <span class="nx">HasName</span> <span class="o">&amp;</span> <span class="nx">HasAddress</span><span class="p">):</span> <span class="nx">PackageLabel</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">prepareShipment</span><span class="p">(</span><span class="nx">recipient</span><span class="p">:</span> <span class="nx">HasName</span> <span class="o">&amp;</span> <span class="nx">HasEmail</span> <span class="o">&amp;</span> <span class="nx">HasAddress</span><span class="p">):</span> <span class="nx">Shipment</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">label</span> <span class="o">=</span> <span class="nx">generateLabel</span><span class="p">(</span><span class="nx">recipient</span><span class="p">);</span>
    
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It also gives you a way to easily extend third-party interfaces without incurring the penalty of creating decorators, wrapping, casting and so forth.</p>

<p>Another interesting aspect of its type system are literal types:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">type</span> <span class="nx">John</span> <span class="o">=</span> <span class="s2">"John"</span><span class="p">;</span>
<span class="nx">type</span> <span class="nx">Role</span> <span class="o">=</span> <span class="s2">"admin"</span> <span class="o">|</span> <span class="s2">"guest"</span> <span class="o">|</span> <span class="s2">"regular"</span> <span class="o">|</span> <span class="s2">"manager"</span><span class="p">;</span>
<span class="nx">type</span> <span class="nx">Floor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="mi">3</span> <span class="o">|</span> <span class="mi">4</span> <span class="o">|</span> <span class="mi">5</span> <span class="o">|</span> <span class="mi">6</span><span class="p">;</span>
</code></pre></div></div>

<p>Code specifying <code class="highlighter-rouge">Role</code> or <code class="highlighter-rouge">Floor</code> will only take those literals. You can’t pass any <code class="highlighter-rouge">number</code> as a Floor, or any <code class="highlighter-rouge">string</code> as a Role (though there’s a way to <a href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#type-guards-and-differentiating-types">narrow those types to the subset specified in the union</a>). <code class="highlighter-rouge">John</code> can only be “John”.</p>

<p>When combining literal types with objects and unions, we get Algebraic Data Types.</p>

<h2 id="making-impossible-states-unrepresentable-modelling-with-algebraic-data-types-adts">Making impossible states unrepresentable: modelling with Algebraic Data Types (ADTs)</h2>

<p>Let’s say, for instance, that you fetch data asynchronously in your code. Your ideal UX generates four scenarios:</p>

<ul>
  <li>While fetching the data, you would like to display a loading indicator;</li>
  <li>When you have data, you would like to render it;</li>
  <li>When fetching fails for some reason, you would want to display the error in the UI;</li>
  <li>When refreshing data, you would like to display the loading indicator over the existing data;</li>
</ul>

<p>You might, then, create this model:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">PageData</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="na">isLoading</span><span class="p">:</span> <span class="kr">boolean</span><span class="p">;</span>
  <span class="nx">data</span><span class="p">?:</span> <span class="nx">T</span><span class="p">;</span>
  <span class="nx">error</span><span class="p">?:</span> <span class="nb">Error</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>with these conditionals:</p>

<ul>
  <li>if <code class="highlighter-rouge">data</code> is present, render it;</li>
  <li>if <code class="highlighter-rouge">isLoading</code> is true, render the loading indicator (if <code class="highlighter-rouge">data</code> is also present, render it over the rendered data);</li>
  <li>if <code class="highlighter-rouge">error</code> is present, render the error.</li>
</ul>

<p>It looks fine at a first glance, but it’s not bulletprof. One day, <code class="highlighter-rouge">data</code> and <code class="highlighter-rouge">error</code> could both be present by mistake, which could then result in the wrong UI, or awkward code like <code class="highlighter-rouge">if (!isLoading &amp;&amp; !error &amp;&amp; data) { ... }</code>.</p>

<p>By thinking things through, it becomes clear that some of the data is only relevant in some of the states of the fetching process. <code class="highlighter-rouge">error</code> is only relevant when there’s an <code class="highlighter-rouge">Error</code>, and <code class="highlighter-rouge">data</code> is only relevant when actual <code class="highlighter-rouge">data</code> exists or a refresh is happening. If neither are present, the initial loading is happening.</p>

<p>You <em>could</em> write tests to keep these in check, but <a href="https://wiki.c2.com/?TestsCantProveTheAbsenceOfBugs">tests can’t prove the absence of bugs</a>. If a mistake not covered by them got introduced, it would only be found during runtime (possibly in production). You should, instead, leverage the compiler to ensure you get what you need at the right time, and only what you need:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">FetchingData</span> <span class="p">{</span>
    <span class="nl">_tag</span><span class="p">:</span> <span class="s2">"FETCHING_DATA"</span><span class="p">;</span>
<span class="p">};</span>

<span class="kr">interface</span> <span class="nx">FetchedData</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="na">_tag</span><span class="p">:</span> <span class="s2">"FETCHED_DATA"</span><span class="p">;</span>
    <span class="nl">data</span><span class="p">:</span> <span class="nx">T</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">FetchingFailed</span> <span class="p">{</span>
    <span class="na">_tag</span><span class="p">:</span> <span class="s2">"FETCHING_FAILED"</span><span class="p">;</span>
    <span class="nl">error</span><span class="p">:</span> <span class="nb">Error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">RefreshingData</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="na">_tag</span><span class="p">:</span> <span class="s2">"REFRESHING_DATA"</span><span class="p">;</span>
    <span class="nl">data</span><span class="p">:</span> <span class="nx">T</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">type</span> <span class="nx">FetchData</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nx">FetchingData</span>
  <span class="o">|</span> <span class="nx">FetchedData</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>
  <span class="o">|</span> <span class="nx">RefreshingData</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>
  <span class="o">|</span> <span class="nx">FetchingFailed</span><span class="p">;</span>
  
<span class="kd">const</span> <span class="na">fetchingData</span><span class="p">:</span> <span class="nx">FetchData</span><span class="o">&lt;</span><span class="nx">never</span><span class="o">&gt;</span> <span class="o">=</span> 
  <span class="p">{</span> <span class="na">_tag</span><span class="p">:</span> <span class="s2">"FETCHING_DATA "</span><span class="p">};</span>
  
<span class="kd">const</span> <span class="nx">fetchedData</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="na">data</span><span class="p">:</span> <span class="nx">T</span><span class="p">):</span> <span class="nx">FetchData</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">_tag</span><span class="p">:</span> <span class="s2">"FETCHED_DATA"</span><span class="p">,</span> 
  <span class="nx">data</span> 
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">refreshingData</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="na">data</span><span class="p">:</span> <span class="nx">T</span><span class="p">):</span> <span class="nx">FetchData</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">({</span> 
  <span class="na">_tag</span><span class="p">:</span> <span class="s2">"REFRESHING_DATA"</span><span class="p">,</span> 
  <span class="nx">data</span> 
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">fetchingFailed</span> <span class="o">=</span> <span class="p">(</span><span class="na">error</span><span class="p">:</span> <span class="nb">Error</span><span class="p">):</span> <span class="nx">FetchData</span><span class="o">&lt;</span><span class="nx">never</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">({</span> 
  <span class="na">_tag</span><span class="p">:</span> <span class="s2">"FETCHING_FAILED"</span><span class="p">,</span> 
  <span class="nx">error</span> 
<span class="p">});</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">FetchData&lt;T&gt;</code> is a generic type that is either <code class="highlighter-rouge">FetchingData</code>, <code class="highlighter-rouge">FetchedData&lt;T&gt;</code>, <code class="highlighter-rouge">RefreshingData&lt;T&gt;</code> or <code class="highlighter-rouge">FetchingFailed</code>. It cannot be more than one of them at the same time. Furthermore, you cannot make assumptions about the data: the only thing the alternatives have in common is the <code class="highlighter-rouge">_tag</code> field. You have to verify that field to do anything meaningful, and you can only do something that’s valid within that tag.</p>

<p>That means you can’t have <code class="highlighter-rouge">error</code> and <code class="highlighter-rouge">data</code> at the same time. Nor can you have <code class="highlighter-rouge">error</code> and <code class="highlighter-rouge">isLoading</code>. There’s no way to have an invalid state. TypeScript knows what is possible under each value based on its <code class="highlighter-rouge">_tag</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">state</span><span class="p">:</span> <span class="nx">FetchedData</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">myCurrentState</span><span class="p">();</span>

<span class="k">switch</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">_tag</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="s2">"FETCHING_DATA"</span><span class="p">:</span>
    <span class="k">return</span> <span class="nx">renderIsLoading</span><span class="p">();</span>
  <span class="k">case</span> <span class="s2">"FETCHED_DATA"</span><span class="p">:</span>
    <span class="k">return</span> <span class="nx">renderData</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="k">case</span> <span class="s2">"FETCHING_FAILED"</span><span class="p">:</span>
    <span class="k">return</span> <span class="nx">renderError</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
  <span class="k">case</span> <span class="s2">"REFRESHING_DATA"</span><span class="p">:</span>
    <span class="k">return</span> <span class="nx">renderRefreshing</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If you tried accessing <code class="highlighter-rouge">state.data</code> under any other branch, it would fail.</p>

<p>It’s not uncommon to hear something to the tune of “that’s a lot of code”. I usually point out that many tests will not have to be written, and that it’s a lot clearer than nested if statements or large conditionals.</p>

<h2 id="fp-ts">fp-ts</h2>

<p><a href="https://gcanti.github.io/fp-ts/">fp-ts</a> gives you many of the tools you get in Haskell, PureScript or Scala, and a lot of convenience functions to lift your regular TypeScript to a transformation-friendly style. It encodes higher-kinded types using <a href="https://www.cl.cam.ac.uk/~jdy22/papers/lightweight-higher-kinded-polymorphism.pdf">Lightweight higher-kinded polymorphism</a>, since TypeScript doesn’t have that feature. You get used to specifying HKT instances by hand pretty quickly.</p>

<p>Due to TypeScript’s type inferencing limitations, a lot of your code will use <code class="highlighter-rouge">pipe</code> (it’s not unlike using <code class="highlighter-rouge">|&gt;</code> in Elm). This might make your code confusing at times, and you’ll eventually develop strategies and sensibilities regarding when to extract helpers and break large computations.</p>

<p>Your solutions can be very expressive, and the types will tell you a lot. In the following example, we’ll take that list of animals from earlier, filter by their class and names, then fetch their Wikipedia pages concurrently and build a list of the results, failing the entire computation if an error occurs:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">flow</span> <span class="p">}</span> <span class="k">from</span> <span class="s2">"fp-ts/lib/function"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">pipeable</span> <span class="p">}</span> <span class="k">from</span> <span class="s2">"fp-ts/lib/pipeable"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">A</span> <span class="k">from</span> <span class="s2">"fp-ts/lib/Array"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">O</span> <span class="k">from</span> <span class="s2">"fp-ts/lib/Option"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">TE</span> <span class="k">from</span> <span class="s2">"fp-ts/lib/TaskEither"</span><span class="p">;</span>

<span class="k">import</span> <span class="nx">TaskEither</span> <span class="o">=</span> <span class="nx">TE</span><span class="p">.</span><span class="nx">TaskEither</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">reptilesWithGWikipediaArticles</span><span class="p">:</span> <span class="nx">TaskEither</span><span class="o">&lt;</span><span class="nx">WikipediaArticle</span><span class="p">[]</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">pipe</span><span class="p">(</span>
  <span class="nx">animals</span><span class="p">,</span>
  <span class="nx">A</span><span class="p">.</span><span class="nx">filterMap</span><span class="p">(</span>
    <span class="nx">flow</span><span class="p">(</span>
      <span class="nx">option</span><span class="p">.</span><span class="nx">some</span><span class="p">,</span> 
      <span class="nx">option</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">a</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="kd">class</span> <span class="o">===</span> <span class="s2">"reptile"</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">"g"</span><span class="p">)),</span>
      <span class="nx">option</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">fetchWikipediaArticle</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">),</span>
  <span class="nx">A</span><span class="p">.</span><span class="nx">sequence</span><span class="p">(</span><span class="nx">TE</span><span class="p">.</span><span class="nx">taskEither</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">TaskEither</code> defines an asynchronous computation that can fail. <code class="highlighter-rouge">filterMap</code> allows you to filter an array and change entries at the same time. <code class="highlighter-rouge">sequence</code> allows you to turn a list of asynchronous computations into an asynchronous computation with a list.</p>

<p>fp-ts forms a rich ecosystem of libraries that give you lenses, runtime encoding/decoding of types, parser combinators and other niceties you’ve probably heard about or used.</p>

<h2 id="putting-it-all-together-functional-typescript-in-the-workplace">Putting it all together: Functional TypeScript in the workplace</h2>

<p>We’ve been successfully using all of the above (and very little more) at my day job for 10 months, building a robust HTTP API that’s serving millions of requests per day, integrating with dozens of services. It goes weeks between serving 500s, and using proper types to model computations that can fail forces the team to handle errors and introduce fallback strategies.</p>

<p>I consider it a great technical success. But this is only part of the story: applying it successfully required my team to be comfortable.</p>

<p>Since I was the one tasked with getting the service off the ground, I built a proof-of-concept and presented it to the team. <em>When I had the buy-in</em>, I immediately became responsible for training them and making them comfortable with the codebase. If you find yourself in the same situation, be prepared to pair program, to change pedagogy, to be patient. It’s a very different way to do things, and you should be able to show different solutions in different styles, as well as refrain yourself from reviewing negatively code that could be more functional/terser.</p>

<p>Would I be more satisfied working in Haskell? Perhaps. The fact is I wouldn’t be doing this style of programming professionally, in a conservative technical setting, were it not for node.js being acceptable and TypeScript being adopted by other teams. This pairing makes for a good Trojan horse, and it’s ergonomic enough that the experience ends up being quite pleasant. A lot more people end up being exposed to solving problems differently, to boot.</p>


  </div><a class="u-url" href="/blog/2020/09/11/a-tour-of-typescript-as-a-statically-typed-fp-lang/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Troika Tech</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Troika Tech</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/dodecaphonic"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">dodecaphonic</span></a></li><li><a href="https://www.twitter.com/dodecaphonic"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">dodecaphonic</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Ruby and JS in the streets, Haskell and friends between the sheets.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
